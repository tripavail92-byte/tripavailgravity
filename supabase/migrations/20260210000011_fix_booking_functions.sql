CREATE OR REPLACE FUNCTION public.check_package_availability(package_id_param UUID, check_in_param TIMESTAMPTZ, check_out_param TIMESTAMPTZ) RETURNS BOOLEAN LANGUAGE plpgsql SECURITY DEFINER SET search_path = public AS $$ DECLARE conflict_count INT; BEGIN SELECT COUNT(*) INTO conflict_count FROM public.package_bookings WHERE package_id = package_id_param AND status IN ('confirmed', 'pending') AND (status != 'pending' OR (expires_at IS NOT NULL AND expires_at > NOW())) AND (check_in_date, check_out_date) OVERLAPS (check_in_param, check_out_param); RETURN conflict_count = 0; END; $$;

CREATE OR REPLACE FUNCTION public.calculate_package_price(package_id_param UUID, check_in_param DATE, check_out_param DATE) RETURNS TABLE(total_price NUMERIC, price_per_night NUMERIC, number_of_nights INT) LANGUAGE plpgsql STABLE AS $$ DECLARE pkg_base_price NUMERIC; nights INT; total NUMERIC; BEGIN SELECT base_price_per_night INTO pkg_base_price FROM public.packages WHERE id = package_id_param; IF pkg_base_price IS NULL OR pkg_base_price = 0 THEN RAISE EXCEPTION 'Package has no base price set'; END IF; nights := (check_out_param - check_in_param)::int; IF nights <= 0 THEN RAISE EXCEPTION 'Invalid date range: check-out must be after check-in'; END IF; total := pkg_base_price * nights; RETURN QUERY SELECT total, pkg_base_price, nights; END; $$;
