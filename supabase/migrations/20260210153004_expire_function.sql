CREATE OR REPLACE FUNCTION public.expire_package_bookings() RETURNS TABLE(expired_count INT) LANGUAGE plpgsql SECURITY DEFINER SET search_path = public AS $$ DECLARE affected_rows INT; BEGIN UPDATE public.package_bookings SET status = 'expired' WHERE status = 'pending' AND expires_at IS NOT NULL AND expires_at < NOW(); GET DIAGNOSTICS affected_rows = ROW_COUNT; RETURN QUERY SELECT affected_rows; END; $$;
